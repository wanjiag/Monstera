---
title: "raw_fMRI"
author: "Wanjia Guo"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    toc: true
    toc_float: true
    theme: journal
editor_options: 
  chunk_output_type: console
---


```{r include = FALSE}
library(tidyverse)
library(fs)
library(ggplot2)
theme_set(theme_minimal(15))

library(ezPurrr)
```


# Reading and cleaning files

```{r}

rois= c('ca23dg-body_thre_0.5_masked',
        'ca1-body_thre_0.5_masked',
        'ca23dg_thre_0.5_masked',
        'ca1_thre_0.5_masked', 
        'angular_gyrus_2_epi_thre_0.5_masked',
        'evc_2_epi_thre_0.5_masked', 
        'hippocampus_2_epi_thre_0.5_masked',
        'ppa_mni_2_epi_thre_0.5_masked')

rois_names = c('ca23dg_body', 'ca1_body', 
               'ca23dg', 'ca1',
               'angular_gyrus', 'evc', 
               'hippocampus', 'ppa')

converting_read <- function(curr_path){
  print(curr_path)
  read_csv(curr_path) %>% mutate(sub = as.character(sub))
}

sub_dir = dir_ls(here::here("./csv_files/fMRI"))

for (i in c(1:length(rois))){
  curr_files <- map(sub_dir, dir_ls, glob = paste0('*/',rois[i],'*.csv')) %>% unlist()
  curr_df <- map_dfr(curr_files, converting_read)
  colnames(curr_df)[1] <- 'TR'
  curr_df <- curr_df %>% mutate(
      run = as.integer(stringr::str_extract(run, "\\d+")),
      sub = as.factor(stringr::str_extract(sub, "\\d+")),
      roi = rois_names[i])
  assign(rois_names[i], curr_df)
}

```



```{r}
nest_df = left_join(event, evc, by = c('behav_TR' = 'TR',
                                     'sub' = 'sub',
                                     'round' = 'run')) %>% 
  group_by(sub, pair, route, segment, valid, within_trial_TR, odd.even) %>% 
  summarise_if(is.numeric, mean) %>% 
  group_by(sub, pair, route, segment, valid, within_trial_TR) %>%
  nest()

row_corr <- function(data){
  
sample = data %>% 
  select(-c(round, trial, behav_TR)) %>% 
  pivot_longer(!odd.even,
               values_to = 'v') %>% 
  pivot_wider(names_from = odd.even,
              values_from = v)

  sample = sample[complete.cases(sample), ]

  cor(sample$even, sample$odd)
}


broadcasted_df = nest_df %>% 
  broadcast(row_corr)

broadcasted_df$corr = as.numeric(unlist(broadcasted_df$output))

sub_df = broadcasted_df %>% group_by(valid, within_trial_TR, segment, sub) %>% 
  summarise(m = mean(corr)) %>% 
  group_by(valid, within_trial_TR, segment) %>% 
  summarise(m2 = mean(m),
            se = sd(m)/sqrt(n()),
            n = n())

sub_df$valid = as.factor(sub_df$valid)

sub_df %>% 
  ggplot(aes(x = within_trial_TR, y = m2, group = valid, color = valid)) + 
  geom_errorbar(aes(ymin = m2-se, ymax = m2+se))+
  geom_line()

```



