---
title: "raw_fMRI"
author: "Wanjia Guo"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    toc: true
    toc_float: true
    theme: journal
editor_options: 
  chunk_output_type: console
---


```{r include = FALSE}
library(tidyverse)
library(fs)
library(ggplot2)
theme_set(theme_minimal(15))
```


# Reading and cleaning files

```{r}

rois= c('ashs/body/ca23dg-body_epi-space_thre_0.5',
        'ashs/body/ca1-body_epi-space_thre_0.5',
        'ashs/whole/ca23dg_epi-space_thre_0.5',
        'ashs/whole/ca1_epi-space_thre_0.5', 
        'angular_gyrus_2_epi_thre_0.5', 
        'evc_2_epi_thr_0.5', 
        'hippocampus_2_epi_thre_0.5', 
        'ppa_mni_2_epi_thr_0.5')

rois_names = c('ca23dg_body', 'ca1_body', 
               'ca23dg', 'ca1',
               'angular_gyrus', 'evc', 
               'hippocampus', 'ppa')

converting_read <- function(curr_path){
  print(curr_path)
  read_csv(curr_path) %>% mutate(sub = as.character(sub))
}

sub_dir = dir_ls(here::here("./csv_files/fMRI"))
# Loading behavioral data
for (i in c(1:length(rois))){
  curr_files <- map(sub_dir, dir_ls, glob = paste0('*/',rois[i],'*.csv')) %>% unlist()
  curr_df <- map_dfr(curr_files, converting_read)%>% 
    mutate(
      TR = `X1`+1,
      adjusted_TR = TR-6,
      run = as.integer(stringr::str_extract(run, "\\d+")),
      sub = as.factor(stringr::str_extract(sub, "\\d+"))) %>% 
    select(-`X1`)
  assign(rois_names[i], curr_df)
}

```



```{r}
event = event %>% filter(sub == '06') 
#tmp_fmri = fmri_df %>% select("TR", "sub", "round", "roi", 0:10)

calculate_cor <- function(x){
  cor(t(x[,-1]))[1,2]
}

s1 = full_join(fmri_df, tmp_event, by = c("TR", "sub", "round")) %>% 
  fill(trial, pair, route, valid, segment, catch) %>% 
  filter(catch != 1 & segment != 'lead in' & TR >= 0) %>% 
  select(-catch) %>%
  group_by(sub, round, roi, trial, pair, route, valid) %>% 
  mutate(id = row_number()) %>% 
  mutate(odd_even = ifelse(round %% 2 == 0, 'even', 'odd'))
```

```{r}
tmp = s1 %>% mutate(type = ifelse(segment == 'fixation' | segment == 'cue', 'transition', 'image')) %>% group_by(type) %>% 
  summarise(across(0:1125, mean))
  
tmp = data.frame(ID=tmp[,1], Means=rowMeans(tmp[,-1]))

ggplot(tmp, aes(x = type, y = Means)) + geom_bar(stat = 'identity')
```

```{r}
s2 = s1 %>% 
  filter(segment == 'same' | segment == 'overlapping' | segment == 'non-overlapping') %>% 
  group_by(sub, roi, pair, route, segment, valid, odd_even, id) %>% 
  # hippocampus: 1776; ppa: 1125; evc: 1048
  summarise(across(0:1048, mean)) %>% 
  group_by(sub, roi, pair, route, segment, valid, id) %>% 
  nest() %>% 
  
  
  mutate(correlation = map_dbl(data, calculate_cor)) %>% 
  mutate(timepoint = id - 4)

s2$valid = as.factor(s2$valid)
s2$segment = as.factor(s2$segment)

s2_1 = s2 %>% group_by(segment, valid, timepoint) %>% 
  summarise(m = mean(correlation))

s3 = s2 %>% group_by(segment, valid) %>% 
  summarise(m = mean(correlation))
s3 <- s3 %>% 
  mutate(segment = fct_relevel(segment, c("same", "overlapping", "non-overlapping")))

s4 = s2 %>% group_by(segment) %>% 
  summarise(m = mean(correlation),
            sd = sd(correlation),
            n = n())
s4 <- s4 %>% 
  mutate(segment = fct_relevel(segment, c("same", "overlapping", "non-overlapping")))


ggplot(s2_1, aes(x = timepoint, y = m)) + geom_line()+
  labs(y = 'mean correlation')

ggplot(s2_1, aes(x = timepoint, y = m)) + 
  geom_line(aes(color = valid)) +
  theme(legend.position = 'top')+
  labs(y = 'mean correlation')

ggplot(s4, aes(x = segment, y = m)) + 
  geom_bar(stat = 'identity') +
  labs(y = 'mean correlation')

ggplot(s3, aes(x = segment, y = m, fill = valid)) + 
  geom_bar(stat = 'identity', position = 'dodge')+
  theme(legend.position = 'top') +
  labs(y = 'mean correlation')

```


